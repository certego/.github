name: Reusable release and tag workflow
on:
  workflow_call:
    inputs:
      publish_on_pypi:
        description: Upload on pypi public index
        type: boolean
        required: false
        default: false

      publish_on_test_pypi:
        description: Upload on test pypi public index
        type: boolean
        required: false
        default: false

      publish_on_npm:
        description: Upload on npm public index
        type: boolean
        required: false
        default: false

jobs:
  release_and_tag:
    name: Create release and tag
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && ( github.base_ref == 'master' || github.base_ref == 'main' )
    steps:
      - uses: actions/checkout@v3

      - name: Check Tag
        id: check-tag
        run: |
          if [[ ${{ github.event.pull_request.title }} =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "match=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Tag and Release
        id: create-release
        if: steps.check-tag.outputs.match == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.pull_request.title }}
          name: Version ${{ github.event.pull_request.title }}
          draft: false
          generate_release_notes: true
          prerelease: false
          target_commitish: ${{ github.base_ref }}

      - uses: actions/setup-python@v1
        if: inputs.publish_on_pypi || inputs.publish_on_test_pypi
        with:
          python-version: "3.x"

      - name: Install dependencies and build
        if: inputs.publish_on_pypi || inputs.publish_on_test_pypi
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine
          python setup.py sdist bdist_wheel
        shell:
          bash

      - name: Publish to test PyPi
        uses: pypa/gh-action-pypi-publish@release/v1
        if: inputs.publish_on_test_pypi
        with:
          user: __token__
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}

      - name: Publish to PyPi
        uses: pypa/gh-action-pypi-publish@release/v1
        if: inputs.publish_on_pypi
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

      - uses: actions/setup-node@v3
        if: inputs.publish_on_npm
        with:
          node-version: '16.x'
          registry-url: 'https://registry.npmjs.org'
          scope: '@certego'

      - run: npm publish --access public
        if: inputs.publish_on_npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_API_TOKEN }}
